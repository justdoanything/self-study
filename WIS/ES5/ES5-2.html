<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°-ES5</title>
    <script src="_.js"></script>
    <script src="partial.js"></script>
  </head>

  <body>
    ğŸ”° Reference :
    <a
      href="https://www.inflearn.com/course/%ED%95%A8%EC%88%98%ED%98%95-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D/lecture/6776?tab=curriculum&volume=1.00&speed=1.5"
      >Inflearn - ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•Œì•„ë³´ëŠ” í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë° (ES5)</a
    >
    <script>
      var users = [
        { id: 101, name: "ID" },
        { id: 102, name: "BJ" },
        { id: 103, name: "PJ" },
        { id: 104, name: "HA" },
        { id: 105, name: "JE" },
        { id: 106, name: "JI" },
      ];

      var posts = [
        { id: 201, body: "ë‚´ìš©1", user_id: 101 },
        { id: 202, body: "ë‚´ìš©2", user_id: 102 },
        { id: 203, body: "ë‚´ìš©3", user_id: 103 },
        { id: 204, body: "ë‚´ìš©4", user_id: 102 },
        { id: 205, body: "ë‚´ìš©5", user_id: 101 },
      ];

      var comments = [
        { id: 301, body: "ëŒ“ê¸€1", user_id: 105, post_id: 201 },
        { id: 302, body: "ëŒ“ê¸€2", user_id: 104, post_id: 201 },
        { id: 303, body: "ëŒ“ê¸€3", user_id: 104, post_id: 202 },
        { id: 304, body: "ëŒ“ê¸€4", user_id: 105, post_id: 203 },
        { id: 305, body: "ëŒ“ê¸€5", user_id: 106, post_id: 203 },
        { id: 306, body: "ëŒ“ê¸€6", user_id: 106, post_id: 204 },
        { id: 307, body: "ëŒ“ê¸€7", user_id: 102, post_id: 205 },
        { id: 308, body: "ëŒ“ê¸€8", user_id: 103, post_id: 204 },
        { id: 309, body: "ëŒ“ê¸€9", user_id: 103, post_id: 202 },
        { id: 310, body: "ëŒ“ê¸€10", user_id: 105, post_id: 201 },
      ];

      // 1. íŠ¹ì •ì¸ì˜ postsì˜ ëª¨ë“  comments ê±°ë¥´ê¸°
      function posts_by(attr) {
        return _.where(posts, attr);
      }

      var comments_by_posts = _.pipe(_.pluck("id"), function (post_ids) {
        return _.filter(comments, function (comment) {
          return _.contains(post_ids, comment.post_id);
        });
      });

      var f1 = _.pipe(posts_by, comments_by_posts);

      console.log(f1({ user_id: 101 }));

      // 2. íŠ¹ì •ì¸ì˜ postsì— commentsë¥¼ ë‹¨ ì¹œêµ¬ì˜ ì´ë¦„ë“¤ ë½‘ê¸°
      var comments_to_user_names = _.map(function (comment) {
        return _.find(users, function (user) {
          return user.id == comment.user_id;
        }).name;
      });

      var f2 = _.pipe(f1, comments_to_user_names, _.uniq);

      console.log(f2({ user_id: 101 }));

      // 3. íŠ¹ì •ì¸ì˜ postsì— commentsë¥¼ ë‹¨ ì¹œêµ¬ë“¤ ì¹´ìš´íŠ¸ ì •ë³´
      var f3 = _.pipe(f1, comments_to_user_names, _.count_by);

      console.log(f3({ user_id: 101 }));

      // 4. íŠ¹ì •ì¸ì´ commentë¥¼ ë‹¨ posts ê±°ë¥´ê¸°
      _.go(
        _.where(comments, { user_id: 105 }),
        _.pluck("post_id"),
        _.uniq,
        function (post_ids) {
          return _.filter(posts, function (post) {
            return _.contains(post_ids, post.id);
          });
        },
        console.log
      );

      // 5. users + posts + comments (index_byì™€ group_byë¡œ íš¨ìœ¨ ë†’ì´ê¸°)
      var users2 = _.index_by(users, "id");
      var comments2 = _.go(
        comments,
        _.map(function (comment) {
          return _.extend(
            {
              user: users2[comment.user_id],
            },
            comment
          );
        }),
        _.group_by("post_id")
      );

      console.log(comments2);

      var posts2 = _.go(
        posts,
        _.map(function (post) {
          return _.extend(
            {
              comments: comments2[post.id] || [],
              user: users2[post.user_id],
            },
            post
          );
        })
      );

      var posts3 = _.group_by(posts2, "user_id");
      console.log(posts3);

      var users3 = _.map(users2, function (user) {
        return _.extend(
          {
            posts: posts3[user.id] || [],
          },
          user
        );
      });

      console.log(users3);

      // 5.1. íŠ¹ì •ì¸ì˜ postsì˜ ëª¨ë“  comments ê±°ë¥´ê¸°
      var user = users3[0];
      _.go(user.posts, _.pluck("comments"), _.flatten, console.log);

      console.log(_.deep_pluck(user, "posts.comments"));

      // 5.2. íŠ¹ì •ì¸ì˜ postsì— commentsë¥¼ ë‹¨ ì¹œêµ¬ì˜ ì´ë¦„ë“¤ ë½‘ê¸°
      _.go(
        user.posts,
        _.pluck("comments"),
        _.flatten,
        _.pluck("user"),
        _.pluck("name"),
        _.uniq,
        console.log
      );

      _.go(user, _.deep_pluck("posts.comments.user.name"), _.uniq, console.log);

      // 5.3. íŠ¹ì •ì¸ì˜ postsì— commentsë¥¼ ë‹¨ ì¹œêµ¬ë“¤ ì¹´ìš´íŠ¸ ì •ë³´
      _.go(
        user.posts,
        _.pluck("comments"),
        _.flatten,
        _.pluck("user"),
        _.pluck("name"),
        _.count_by,
        console.log
      );

      _.go(
        user,
        _.deep_pluck("posts.comments.user.name"),
        _.count_by,
        console.log
      );

      // 5.4. íŠ¹ì •ì¸ì´ commentë¥¼ ë‹¨ posts ê±°ë¥´ê¸°
      console.log(
        _.filter(posts2, function (post) {
          return _.find(post.comments, function (comment) {
            return comment.user_id == 105;
          });
        })
      );
    </script>
  </body>
</html>
